<?xml version="1.0" encoding="UTF-8"?>
<project name="Test project" default="set-up" basedir="" description="Test project">
    <!--Properties-->
    <if><not><isset property="environment" /></not>
        <then>
            <property name="environment" value="dev"/>
        </then>
        <else>
            <echo>Environment: ${environment}</echo>
        </else>
    </if>
    <property name="pdo.host" value="192.168.3.15"/>
    <property name="pdo.user" value="root"/>
    <property name="pdo.password" value="root"/>
    <property name="pdo.dbname" value="test_bd"/>

    <if><not><isset property="version" /></not>
        <then>
            <property name="project.version" value="1"/>
        </then>
        <else>
            <property name="project.version" value="2"/>
        </else>
    </if>

    <target name="composer-install" >
        <echo msg="Installing composer libraries" />
        <exec command="php composer.phar self-update" dir="" escape="false" passthru="true"/>
        <exec command="php composer.phar install" dir="" escape="false" passthru="true"/>
    </target>

    <target name="create-database-structure">
        <!--Initializing database-->
        <echo msg="Creating database" />
        <exec command="php app/console doctrine:database:create" escape="false" passthru="true"/>
        <echo msg="Creating database" />
        <pdosqlexec url="mysql:host=${pdo.host}" userid="${pdo.user}" password="${pdo.password}" onerror="abort" autocommit="true">
            DROP DATABASE IF EXISTS ${pdo.dbname};
            CREATE DATABASE ${pdo.dbname};
        </pdosqlexec>
        <pdosqlexec url="mysql:host=${pdo.host};dbname=${pdo.dbname}" userid="${pdo.user}" password="${pdo.password}" onerror="abort">

            <fileset dir="build/db/">
                <include name="*.sql"/>
            </fileset>
        </pdosqlexec>
    </target>

    <!--Set Up-->
    <target name="set-up" depends="create-database-structure">
        <if>
            <equals arg1="${project.version}" arg2="1" />
            <then>
                <phingcall target="composer-install" />
            </then>
            <else>
                <echo msg="Database should be already createed" />
            </else>
        </if>
    </target>

</project>